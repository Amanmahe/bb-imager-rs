stages:
  - test
  - build
  - deploy

clippy:
  image: "rust:latest"
  stage: test
  tags:
    - docker-amd64
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends libudev-dev
    - rustup component add clippy
  script:
    - cargo clippy --all-targets --all-features --no-deps

test:
  image: "rust:latest"
  stage: test
  tags:
    - docker-amd64
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends libudev-dev
  script:
    - rustc --version && cargo --version  # Print version info for debugging
    - cargo test --workspace --verbose

windows:
  image: "rust:latest"
  tags:
    - docker-amd64
  variables:
    RUST_BUILDER: cargo
  stage: build
  before_script:
    - echo "Download dependencies"
    - apt-get update && apt-get --assume-yes install gcc-mingw-w64 zip
    - rustup target add x86_64-pc-windows-gnu
  script:
    - make release-windows-x86_64-pc-windows-gnu
  artifacts:
    paths:
      - release/

linux_x86_64:
  image: "rust:latest"
  tags:
    - docker-amd64
  variables:
    RUST_BUILDER: cargo
  stage: build
  before_script:
    - echo "Download dependencies"
    - apt-get update && apt-get --assume-yes install libssl-dev libudev-dev desktop-file-utils
    - echo "Setup appimagetool"
    - wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-$(uname -m).AppImage -O /usr/local/bin/appimagetool
    - chmod +x /usr/local/bin/appimagetool
    - sed -i 's|AI\x02|\x00\x00\x00|' /usr/local/bin/appimagetool
    - rustup target add x86_64-unknown-linux-gnu
    - cargo install cargo-deb
  script:
    - make release-linux-x86_64-unknown-linux-gnu
  artifacts:
    paths:
      - release/

linux_aarch64:
  image: "rust:latest"
  tags:
    - docker-amd64
  variables:
    RUST_BUILDER: cargo
    CROSS_ARCH: arm64
    PKG_CONFIG_ALLOW_CROSS: 1
    CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
  stage: build
  before_script:
    - echo "Download dependencies"
    - dpkg --add-architecture ${CROSS_ARCH}
    - apt-get update && apt-get --assume-yes install libssl-dev:${CROSS_ARCH} libudev-dev:${CROSS_ARCH} desktop-file-utils gcc-aarch64-linux-gnu
    - echo "Setup appimagetool"
    - wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-$(uname -m).AppImage -O /usr/local/bin/appimagetool
    - chmod +x /usr/local/bin/appimagetool
    - sed -i 's|AI\x02|\x00\x00\x00|' /usr/local/bin/appimagetool
    - rustup target add aarch64-unknown-linux-gnu
    - cargo install cargo-deb
  script:
    - PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig/:${PKG_CONFIG_PATH}" make release-linux-aarch64-unknown-linux-gnu
  artifacts:
    paths:
      - release/

linux_arm:
  image: "rust:latest"
  tags:
    - docker-amd64
  variables:
    RUST_BUILDER: cargo
    CROSS_ARCH: armhf
    PKG_CONFIG_ALLOW_CROSS: 1
    CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER: arm-linux-gnueabihf-gcc
  stage: build
  before_script:
    - echo "Download dependencies"
    - dpkg --add-architecture ${CROSS_ARCH}
    - apt-get update && apt-get --assume-yes install libssl-dev:${CROSS_ARCH} libudev-dev:${CROSS_ARCH} desktop-file-utils gcc-arm-linux-gnueabihf
    - echo "Setup appimagetool"
    - wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-$(uname -m).AppImage -O /usr/local/bin/appimagetool
    - chmod +x /usr/local/bin/appimagetool
    - sed -i 's|AI\x02|\x00\x00\x00|' /usr/local/bin/appimagetool
    - rustup target add armv7-unknown-linux-gnueabihf
    - cargo install cargo-deb
  script:
    - PKG_CONFIG_PATH="/usr/lib/arm-linux-gnueabihf/pkgconfig/:${PKG_CONFIG_PATH}" make release-linux-armv7-unknown-linux-gnueabihf
  artifacts:
    paths:
      - release/

macos:
  image: macos-14-xcode-15
  stage: build
  tags:
    - macos
  variables:
    RUST_BUILDER: cargo
  before_script:
    - brew install create-dmg rustup git-lfs
    - git lfs install
    - git lfs fetch
    - git lfs checkout
    - rustup target add x86_64-apple-darwin aarch64-apple-darwin
  script:
    - rustc --version
    - make release-darwin-x86_64-apple-darwin
    - make release-darwin-aarch64-apple-darwin
  artifacts:
    paths:
      - release/

deploy:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG
  variables:
    VERSION: ${CI_COMMIT_TAG}
    PACKAGE_REGISTRY_URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic
    PACKAGE_REGISTRY_GUI_URL: ${PACKAGE_REGISTRY_URL}/bb-imager-gui/${VERSION}
    PACKAGE_REGISTRY_CLI_URL: ${PACKAGE_REGISTRY_CLI_URL}/bb-imager-cli/${VERSION}
  before_script:
    - apk add --no-cache make curl jq
  script:
    - echo "running release_job for $CI_COMMIT_TAG"
    - 'curl -H "PRIVATE-TOKEN: $CI_API_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/changelog?version=$CI_COMMIT_TAG" | jq -r .notes > release_notes.md'
    - make upload-artifacts
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'BeagleBoard Imager $CI_COMMIT_TAG'
    description: release_notes.md
    ref: '$CI_COMMIT_SHA'
    assets:
      links:
        - name: 'x86_64-bb-imager-cli-windows.zip'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-pc-windows-gnu.zip'
          link_type: 'package'
        - name: 'x86_64-bb-imager-cli-windows.zip.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-pc-windows-gnu.zip.sha256'

        - name: 'x86_64-bb-imager-gui-windows.zip'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-pc-windows-gnu.zip'
          link_type: 'package'
        - name: 'x86_64-bb-imager-gui-windows.zip.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-pc-windows-gnu.zip.sha256'

        - name: 'x86_64-bb-imager-cli-linux.xz'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-unknown-linux-gnu.xz'
          link_type: 'package'
        - name: 'x86_64-bb-imager-cli-linux.xz.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-unknown-linux-gnu.xz.sha256'

        - name: 'x86_64-bb-imager-cli-linux.deb'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-unknown-linux-gnu.deb'
          link_type: 'package'
        - name: 'x86_64-bb-imager-cli-linux.deb.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-unknown-linux-gnu.deb.sha256'

        - name: 'x86_64-bb-imager-gui-linux.AppImage'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-unknown-linux-gnu.AppImage'
          link_type: 'package'
        - name: 'x86_64-bb-imager-gui-linux.AppImage.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-unknown-linux-gnu.AppImage.sha256'

        - name: 'x86_64-bb-imager-gui-linux.deb'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-unknown-linux-gnu.deb'
          link_type: 'package'
        - name: 'x86_64-bb-imager-gui-linux.deb.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-unknown-linux-gnu.deb.sha256'

        - name: 'aarch64-bb-imager-cli-linux.xz'
          url: '${PACKAGE_REGISTRY_CLI_URL}/aarch64-unknown-linux-gnu.xz'
          link_type: 'package'
        - name: 'aarch64-bb-imager-cli-linux.xz.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/aarch64-unknown-linux-gnu.xz.sha256'

        - name: 'aarch64-bb-imager-cli-linux.deb'
          url: '${PACKAGE_REGISTRY_CLI_URL}/aarch64-unknown-linux-gnu.deb'
          link_type: 'package'
        - name: 'aarch64-bb-imager-cli-linux.deb.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/aarch64-unknown-linux-gnu.deb.sha256'

        - name: 'aarch64-bb-imager-gui-linux.AppImage'
          url: '${PACKAGE_REGISTRY_GUI_URL}/aarch64-unknown-linux-gnu.AppImage'
          link_type: 'package'
        - name: 'aarch64-bb-imager-gui-linux.AppImage.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/aarch64-unknown-linux-gnu.AppImage.sha256'

        - name: 'aarch64-bb-imager-gui-linux.deb'
          url: '${PACKAGE_REGISTRY_GUI_URL}/aarch64-unknown-linux-gnu.deb'
          link_type: 'package'
        - name: 'aarch64-bb-imager-gui-linux.deb.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/aarch64-unknown-linux-gnu.deb.sha256'

        - name: 'arm-bb-imager-cli-linux.xz'
          url: '${PACKAGE_REGISTRY_CLI_URL}/armv7-unknown-linux-gnueabihf.xz'
          link_type: 'package'
        - name: 'arm-bb-imager-cli-linux.xz.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/armv7-unknown-linux-gnueabihf.xz.sha256'

        - name: 'arm-bb-imager-cli-linux.deb'
          url: '${PACKAGE_REGISTRY_CLI_URL}/armv7-unknown-linux-gnueabihf.deb'
          link_type: 'package'
        - name: 'arm-bb-imager-cli-linux.deb.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/armv7-unknown-linux-gnueabihf.deb.sha256'

        - name: 'arm-bb-imager-gui-linux.AppImage'
          url: '${PACKAGE_REGISTRY_GUI_URL}/armv7-unknown-linux-gnueabihf.AppImage'
          link_type: 'package'
        - name: 'arm-bb-imager-gui-linux.AppImage.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/armv7-unknown-linux-gnueabihf.AppImage.sha256'

        - name: 'arm-bb-imager-gui-linux.deb'
          url: '${PACKAGE_REGISTRY_GUI_URL}/armv7-unknown-linux-gnueabihf.deb'
          link_type: 'package'
        - name: 'arm-bb-imager-gui-linux.deb.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/armv7-unknown-linux-gnueabihf.deb.sha256'

        - name: 'aarch64-bb-imager-cli-darwin.zip'
          url: '${PACKAGE_REGISTRY_CLI_URL}/aarch64-apple-darwin.zip'
          link_type: 'package'
        - name: 'aarch64-bb-imager-cli-darwin.zip.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/aarch64-apple-darwin.zip.sha256'

        - name: 'aarch64-bb-imager-gui-darwin.dmg'
          url: '${PACKAGE_REGISTRY_GUI_URL}/aarch64-apple-darwin.dmg'
          link_type: 'package'
        - name: 'aarch64-bb-imager-gui-darwin.dmg.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/aarch64-apple-darwin.dmg.sha256'

        - name: 'x86_64-bb-imager-cli-darwin.zip'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-apple-darwin.zip'
          link_type: 'package'
        - name: 'x86_64-bb-imager-cli-darwin.zip.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/x86_64-apple-darwin.zip.sha256'

        - name: 'x86_64-bb-imager-gui-darwin.dmg'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-apple-darwin.dmg'
          link_type: 'package'
        - name: 'x86_64-bb-imager-gui-darwin.dmg.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/x86_64-apple-darwin.dmg.sha256'

        - name: 'universal-bb-imager-cli-darwin.zip'
          url: '${PACKAGE_REGISTRY_CLI_URL}/universal-apple-darwin.zip'
          link_type: 'package'
        - name: 'universal-bb-imager-cli-darwin.zip.sha256'
          url: '${PACKAGE_REGISTRY_CLI_URL}/universal-apple-darwin.zip.sha256'

        - name: 'universal-bb-imager-gui-darwin.dmg'
          url: '${PACKAGE_REGISTRY_GUI_URL}/universal-apple-darwin.dmg'
          link_type: 'package'
        - name: 'universal-bb-imager-gui-darwin.dmg.sha256'
          url: '${PACKAGE_REGISTRY_GUI_URL}/universal-apple-darwin.dmg.sha256'
